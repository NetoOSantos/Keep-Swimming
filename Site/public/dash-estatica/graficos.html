z<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Keep Swimming | Monitoramento</title>
	<link rel="stylesheet" href="nav.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
	<script src="http://www.chartjs.org/samples/latest/utils.js"></script>
	<script src="../../src/controllers/medidaController.js"></script>

	<style>
		.canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>

</head>

<body onload="obterDadosGrafico(1)">

	<div class="header">
		<img src="./logo ppt2.png" alt="" height="60px">
	</div>

	<div class="corpoDecima">


		<div id="sidebarMenu">
			<ul class="sidebarMenuInner">
				<li><a href="./dashboard.html"><img src="./dash.png" alt="" height="25px"> Dashboard</a> </li>
				<li> <a href="graficos.html"><img src="./monitoramento.png" alt="" height="25px">Monitoramento</a></li>
				<li> <a href="dash-cadastros.html"><img src="./perfil.png" alt="" height="25px">Cadastrar
						Desenvolvedor</a></li>
				<li> <a href="https://app.pipefy.com/public/form/w7YSTr_A">
						<img src="./suporte.png" alt="" height="25px"> Suporte</a></li>
				<li><a href="../index.html">
						<div class="sair">
							<img src="./logout 1.png" alt="" height="50px">
						</div>
					</a></li>
			</ul>
		</div>

		<div id='center' class="main">
			<div class="dash">
				<div class="div_maquinas">
					<button class="div_maquina1" onclick="obterDadosGrafico(1)"><b>Bruno</b></button>
					<button class="div_maquina2" onclick="obterDadosGrafico(2)"><b>Lucas</b></button>
					<button class="div_maquina3" onclick="obterDadosGrafico(3)"><b>Raul</b></button>
					<button class="div_maquina4" onclick="obterDadosGrafico(4)"><b>Victor</b></button>
					<button class="div_maquina5" onclick="obterDadosGrafico(5)"><b>Neto</b></button>
				</div>
				<div class="regua">
					<div class="item-regua perigo-frio">
						<h4>Consumo CPU</h4>
						<h2 id="consumo_cpu"></h2>
					</div>
					<div class="item-regua alerta-frio">
						<h4>Alerta Critico Baixo</h4>
						<h2>11-25% Consumo</h2>
					</div>
					<div class="item-regua ideal">
						<h4>Ideal</h4>
						<h2>26-75% Consumo</h2>
					</div>
					<div class="item-regua alerta-quente">
						<h4>Alerta Critico Alto</h4>
						<h2>76-90% Consumo</h2>
					</div>
					<div class="item-regua perigo-quente">
						<h4>Alto nível de requisições</h4>
						<h2> 90-100% </h2>
					</div>
				</div>

				<div class="inf_dash">


					<select name="" id="sel_comp" class="sel_componentescss">
						<option value="1">--Selecione--</option>
						<option value="1">Memoria</option>
						<option value="2">processador</option>
						<option value="3">CPU</option>
						<option value="">Memoria virtual</option>
					</select>


					<div class="grafico">
						<h1>
							Monitoramento de Hardware
						</h1>
						<div id="divMostrar"></div>

						<canvas id="chart"></canvas>
						<br>
					</div>

					<div class="div_componente">

					</div>


				</div>
			</div>

		</div>

		<script>

		let proximaAtualizacao;


		function obterDadosGrafico(idMaquina) {
			var componenteSelecionado = sel_comp.value;

				if (proximaAtualizacao != undefined) {
					clearTimeout(proximaAtualizacao);
				}

				if(componenteSelecionado == 1 || componenteSelecionado == 2)
				{

					fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
						if (response.ok) {
							response.json().then(function (resposta) {
								console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
								resposta.reverse();
	
								plotarGrafico(resposta, idMaquina);
							});
						} else {
							console.error('Nenhum dado encontrado ou erro na API');
						}
					})
						.catch(function (error) {
							console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
						});
				} else if (componenteSelecionado == 3){

					fetch(`/medidas/buscarConsumoCPU/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
						if (response.ok) {
							response.json().then(function (resposta) {
								console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
								resposta.reverse();
	
								plotarGrafico(resposta, idMaquina);
							});
						} else {
							console.error('Nenhum dado encontrado ou erro na API');
						}
					})
						.catch(function (error) {
							console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
						});
				}


		}


		function plotarGrafico(resposta, idMaquina) {
			console.log('iniciando plotagem do gráfico...');
			var componenteSelecionado = sel_comp.value;
			var nomeLabel;
			var labelString;

			          if(componenteSelecionado == 1)
					{
						nomeLabel = 'Memoria';		
						labelString = 'Uso MB'
					} else if (componenteSelecionado == 2)
					{					
						nomeLabel = 'Processador';		
						labelString = 'MIPS'		
					}
					else if (componenteSelecionado == 3)
					{
						nomeLabel = 'CPU';
						labelString = 'Uso %'
					}

			
			
			var dados = {
				labels: [],
				datasets: [
					{
						
						label: nomeLabel,
						borderColor: '#32B9CD',
						backgroundColor: '#32b9cd8f',
						fill: true,
						data: []
					}
				]
			};

			for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            console.log("registro::::::::");
            console.log(registro);

			var startIndex = registro.Hora.indexOf('2022 ', 0);
			var endIndex = registro.Hora.indexOf(' ', startIndex);
			var registroHora = registro.Hora.slice(endIndex, endIndex + 9);

			
			console.log(registroHora);
			
			// if(componenteSelecionado == 1)
			// {
			// 	dados.datasets[0].label = 'Memoria'
			// 	var pushDado = dados.datasets[0].data.push(registro.dadosMemoria);

			// } else if(componenteSelecionado == 2)
			// {
			// 	data.datasets[0].label = 'Processador';
			// 	var pushDado = dados.datasets[0].data.push(registro.dadosProcessador);
			// }

            dados.labels.push(registroHora);

			if(componenteSelecionado == 1)
			{
				dados.datasets[0].data.push((registro.dadosMemoria)/1048576);				
			} else if (componenteSelecionado == 2)
			{
				
				dados.datasets[0].data.push(registro.dadosProcessador);				
			}
			else if (componenteSelecionado == 3)
			{
				dados.datasets[0].data.push((registro.usoCPU)/100);
			}
        }

			console.log(JSON.stringify(dados));

		// 	var ctx =chart.getContext('2d');
		// 	window.grafico_linha = Chart.Line(ctx, {
		// 		data: dados,
		// 		//Configurações do gráfico
		// 		options: {
		// 			responsive: true,
		// 			animation: { duration: 500 },
		// 			hoverMode: 'index',
		// 			stacked: false,
		// 			title: {
			// 				display: true,
		// 				text: 'Histórico recente de Luminosidade'
		// 			},
		// 			scales: {
		// 				yAxes: [ {
		// 					type: 'linear',
		// 					display: true,
		// 					position: 'right',
		// 					id: 'y-luminosidade',

		// 					gridLines: {
		// 						drawOnChartArea: false,
		// 					},
		// 				}],
		// 			}
		// 		}
		// 	});

		// 	for (i = 0; i < resposta.length; i++) {
		// 		var registro = resposta[i];
		// 		dados.labels.push(registro.momento_grafico);
		// 		dados.datasets[0].data.push(registro.dadosMemoria);
		// 	}
		
        
        // //Atualiza os dados de 2 em 2 segundos
        // setTimeout(() => atualizarGrafico(idMaquina, dados), 3000);

		var context = document.getElementById("chart").getContext("2d");
		context.canvas.width = 1000;
		context.canvas.height = 400;
	
		window.grafico_linha = Chart.Line(context, {
			type: 'line',
			data: dados,
			options: {
				scales: {
					xAxes: [{
						distribution: 'series',
						ticks: {
							beginAtZero: true
						}
					}],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: labelString
						},
						ticks: {
							beginAtZero: true
						}
					}]
				},
				animation: {
					tension: {
						duration: 1000,
						easing: 'easeInOutBack',
						from: 1,
						to: 0,
						loop: true
					}
	
				}
			}
		});
	
		//var chart = new Chart(context, window.);
		setTimeout(() => atualizarGrafico(idMaquina, dados,componenteSelecionado), 3000);
    }

	function atualizarGrafico(idMaquina, dados, componenteSelecionado) {
		

		var caminhoFetch = ``;

		if(componenteSelecionado == 1 || componenteSelecionado == 2)
		{
			caminhoFetch = "/medidas/tempo-real/";
		} else if (componenteSelecionado == 3)
		{
			caminhoFetch = "/medidas/tempo-real-cpu/";
		}

        fetch(`${caminhoFetch}${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

					var startIndex = novoRegistro[0].Hora.indexOf('2022 ', 0);
					var endIndex = novoRegistro[0].Hora.indexOf(' ', startIndex);
					var registroHora = novoRegistro[0].Hora.slice(endIndex, endIndex + 9);

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico: ${dados.labels}`);
                    console.log(`Dados atuais do gráfico: ${dados.datasets[0].data}`);

                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(registroHora); // incluir um novo momento
                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade

					if(componenteSelecionado == 1)
					{
						dados.datasets[0].data.push((novoRegistro[0].dadosMemoria)/1048576);			
					} else if (componenteSelecionado == 2)
					{						
						dados.datasets[0].data.push(novoRegistro[0].dadosProcessador);				
					}else if (componenteSelecionado == 3)
					{
						dados.datasets[0].data.push((novoRegistro[0].usoCPU)/100)
					}
            

                    // if(novoRegistro[0].logLuminosidade < 300) {
                    //     dados.datasets[0].borderColor = "#cd32328f";
                    //     dados.datasets[0].backgroundColor = "#cd32328f";
                    //     div_msg.innerHTML = `<h2 style="color: #cd32328f;">Luminosidade ${novoRegistro[0].logLuminosidade}, muito abaixo dos padrões ideais, estado crítico!!!</h2><br>
                    //         <h4 style="color: #fff;">Resolva URGENTEMETE o controle de Luminosidade da sua Estufa!</h4>
                    //         `
                    // } else if (novoRegistro[0].logLuminosidade < 400) {
                    //     dados.datasets[0].borderColor = "#eb720f8f";
                    //     dados.datasets[0].backgroundColor = "#eb720f8f";
                    //     div_msg.innerHTML = `<h2 style="color: #eb720f8f;">Luminosidade ${novoRegistro[0].logLuminosidade}, abaixo dos padrões ideais, estado emergêncial</h2><br>
                    //     <h4 style="color: #fff;"> Resolva o controle de Luminosidade da sua Estufa o mais cedo possível</h4>`
                    // } else if (novoRegistro[0].logLuminosidade < 500) {
                    //     dados.datasets[0].borderColor = "#dfca158f";
                    //     dados.datasets[0].backgroundColor = "#dfca158f";
                    //     div_msg.innerHTML = `<h2 style="color: #dfca158f;">Luminosidade ${novoRegistro[0].logLuminosidade}, abaixo do padrão ideal </h2><br>
                    //     <h4 style="color: #fff;"> Cheque o controle de Luminosidade da sua Estufa</h4>`
                    // } else if (novoRegistro[0].logLuminosidade < 900) {
                    //     dados.datasets[0].borderColor = "#6bcd328f";
                    //     dados.datasets[0].backgroundColor = "#6bcd328f";
                    //     div_msg.innerHTML = `<h2 style="color: #6bcd328f;">Luminosidade ${novoRegistro[0].logLuminosidade},  nos padrões ideais</h2> <br>
                    //     <h4 style="color: #fff;"> Nada a se fazer</h4>`
                    // } else if (novoRegistro[0].logLuminosidade < 1000) {
                    //     dados.datasets[0].borderColor = "#dfca158f";
                    //     dados.datasets[0].backgroundColor = "#dfca158f";
                    //     div_msg.innerHTML = `<h2 style="color: #dfca158f;">Luminosidade ${novoRegistro[0].logLuminosidade}, acima dos padrões ideais </h2><br>
                    //     <h4 style="color: #fff;">  Cheque o controle de Luminosidade da sua Estufa</h4>`
                    // } else if (novoRegistro[0].logLuminosidade <= 1100) {
                    //     dados.datasets[0].borderColor = "#eb720f8f";
                    //     dados.datasets[0].backgroundColor = "#eb720f8f";
                    //     div_msg2.innerHTML = `<h2 style="color: #eb720f8f;">Luminosidade ${novoRegistro[0].logLuminosidade}, acima dos padrões ideais, estado emergêncial</h2><br>
                    //     <h4 style="color: #fff;">Resolva o controle de Luminosidade da sua Estufa o mais cedo possível</h4>`
                    // } else if (novoRegistro[0].logLuminosidade > 1100) {
                    //     dados.datasets[0].borderColor = "#cd32328f";
                    //     dados.datasets[0].backgroundColor = "#cd32328f";
                    //     div_msg.innerHTML = `<h2 style="color: #cd32328f;">Luminosidade ${novoRegistro[0].logLuminosidade}, muito acima dos padrões ideais, estado crítico!!!</h2><br>
                    //     <h4 style="color: #fff;"> Resolva URGENTEMETE o controle de Luminosidade da sua Estufa!</h4>`
                    // }

                    window.grafico_linha.update();

                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados,componenteSelecionado), 5000);

                });

                if(novoRegistro[0].dadosMemoria < 650) {
                    //canvas_grafico.dados.datasets[0].backgroundColor = "red"
                }

            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados), 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
	

			// setInterval(() => {
			// 	get_data();
			// }, 800);

		</script>
</body>

</html>






<script>
				//Função para obter os dados de temperatura do server
			//Seria mais interessante fazer isso com WebSocket, porém para fins academicos, os dados serão atualizados via HTTP

			//Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
			//hora de montar/atualizar o gráfico
			// this.lastIndexTemp = 0;
			// this.time = 0;

			// function get_data() {

			// 	var http = new XMLHttpRequest();
			// 	http.open('GET', 'http://localhost:3000/medidas/atividadeSensor', false);//LOCAL DE ONDE VAI OS DADOS
			// 	http.send(null);

			// 	var obj = JSON.parse(http.responseText);
			// 	if (obj.data.length == 0) {
			// 		return;
			// 	}

			// 	var _lastIndexTemp = this.lastIndexTemp;
			// 	this.lastIndexTemp = obj.data.length;
			// 	listTemp = obj.data.slice(_lastIndexTemp);

			// 	listTemp.forEach(data => {
			// 		Máximo de 60 itens exibidos no gráfico
			// 		if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10) {
			// 			chart.data.labels.shift();
			// 			chart.data.datasets[0].data.shift();
			// 		}

			// 		chart.data.labels.push(this.time++);
			// 		chart.data.datasets[0].data.push(parseFloat(data));
			// 		chart.update();
			// 		if (this.time <= 11) {
			// 			divMostrar.innerHTML = '<div style="border-radius: 50%; display: flex; justify-content: center; font-weight: bolder; align-items: center; background-color: red; color: white; width: 30px; heigth: 50px;padding:5px;">' + this.time + '</div>';

			// 		}
			// 		else if (this.time >= 11 && this.time <= 25) {
			// 			divMostrar.innerHTML = '<div style="border-radius: 50%; display: flex; justify-content: center; font-weight: bolder; align-items: center; background-color: yellow; color: black; width: 30px; heigth: 50px;padding:5px;">' + this.time + '</div>';

			// 		}
			// 		else if (this.time >= 26 && this.time <= 74) {
			// 			divMostrar.innerHTML = '<div style="border-radius: 50%; display: flex; justify-content: center; font-weight: bolder; align-items: center; background-color: purple; color: white; width: 30px; heigth: 50px;padding:5px;">' + this.time + '</div>';

			// 		}
			// 		else if (this.time >= 75 && this.time <= 90) {
			// 			divMostrar.innerHTML = '<div style="border-radius: 50%; display: flex; justify-content: center; font-weight: bolder; align-items: center; background-color: #ff7b00; color: white; width: 30px; heigth: 50px;padding:5px;">' + this.time + '</div>';

			// 		}
			// 		else {
			// 			divMostrar.innerHTML = '<div style="border-radius: 50%; display: flex; justify-content: center; font-weight: bolder; align-items: center; background-color:green; color: white; width: 30px; heigth: 50px;padding:5px;">' + this.time + '</div>';

			// 		}
			// 	});
			// 	document.getElementById('average').textContent = obj.average;



			// }
</script>